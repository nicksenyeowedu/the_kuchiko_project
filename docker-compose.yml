version: '3.8'

services:
  memgraph:
    image: memgraph/memgraph-platform:latest
    container_name: memgraph
    ports:
      - "7687:7687"   # Bolt protocol
      - "3000:3000"   # Memgraph Lab (web UI)
      - "7444:7444"   # Memgraph Lab websocket
    volumes:
      - memgraph_data:/var/lib/memgraph
      - memgraph_log:/var/log/memgraph
      - memgraph_etc:/etc/memgraph
    environment:
      - MEMGRAPH_USER=memgraph
      - MEMGRAPH_PASSWORD=memgraph
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "7687"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - kuchiko-network

  init-kg:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kuchiko-init
    depends_on:
      memgraph:
        condition: service_healthy
    environment:
      - NVIDIA_API_KEY=${NVIDIA_API_KEY}
      - MEMGRAPH_URI=bolt://memgraph:7687
      - MEMGRAPH_USER=memgraph
      - MEMGRAPH_PASS=memgraph
      - PDF_PATH=/app/knowledge_base.pdf
      - MAX_WORKERS=${MAX_WORKERS:-4}
    volumes:
      - ./createKG.py:/app/createKG.py:ro
      - ./build_embeddings.py:/app/build_embeddings.py:ro
      - ./${PDF_FILE:-kg.pdf}:/app/knowledge_base.pdf:ro
      - ./data:/app/data
      - ./logs:/app/logs
    command: >
      sh -c "
      echo '==================================' &&
      echo 'ðŸŒ¿ Kuchiko Initialization ðŸŒ¿' &&
      echo '==================================' &&
      echo '' &&
      echo 'ðŸ“Š Step 1/2: Building Knowledge Graph from PDF...' &&
      python createKG.py /app/knowledge_base.pdf &&
      echo 'âœ… Knowledge Graph created!' &&
      echo '' &&
      echo 'ðŸ”§ Step 2/2: Building FAISS embeddings index...' &&
      python build_embeddings.py &&
      echo 'âœ… FAISS index built!' &&
      echo '' &&
      echo '==================================' &&
      echo 'âœ… Initialization Complete!' &&
      echo '==================================' &&
      echo 'Knowledge Graph and FAISS index are ready.'
      "
    networks:
      - kuchiko-network
    restart: "no"

  chatbot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kuchiko-chatbot
    depends_on:
      init-kg:
        condition: service_completed_successfully
    environment:
      - NVIDIA_API_KEY=${NVIDIA_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - MEMGRAPH_URI=bolt://memgraph:7687
      - MEMGRAPH_USER=memgraph
      - MEMGRAPH_PASS=memgraph
    volumes:
      - ./chatbot_telegram.py:/app/chatbot_telegram.py:ro
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - kuchiko-network

volumes:
  memgraph_data:
  memgraph_log:
  memgraph_etc:

networks:
  kuchiko-network:
    driver: bridge
